----
Seção 1
Prática: Log Collection com rsyslog
----

1. Ver status do rsyslog
	sudo systemctl status rsyslog

2. Criar arquivo
	sudo vim /etc/rsyslog.d/98-websrv-02-sshd.conf

3. Adicionar conteúdo
	$FileCreateMode 0644
	:programname, isequal, "sshd" /var/log/websrv-02/rsyslog_sshd.log

4. Status rsyslog
	sudo systemctl status rsyslog
	systemctl restart syslog.socket rsyslog.service

5. Acessar diretório
	cd /var/log/websrv-02

6. Conectar remoto
	sudo ssh kali@localhost -p 22

7. Visualizar conteúdo do arquivo
	cat rsyslog_sshd.log

----
Perguntas
----

1. Após configurar o rsyslog para sshd, qual nome de usuário aparece nos logs do sshd em /var/log/websrv-02/rsyslog_sshd.log?

2. Existe algo indicando tentativas de login com falha ou força bruta?

3. Qual é o endereço IP aparece no conteúdo do arquivo de /var/log/websrv-02/rsyslog_sshd.log?

4. Com base nos logs gerados em /var/log/websrv-02/rsyslog_sshd.log, existe algum comando executado pelo usuário root?


----
Seção 2
Pratica: Log Management com logrotate
----

logrotate: ferramenta que automatiza a rotação, compressão e gerenciamento de arquivos de log, garantindo que os arquivos de log sejam manipulados sistematicamente.

1. Acessa o diretório:
	cd /var/log/websrv-02

2. Criar arquivo conf:
	sudo vim /etc/logrotate.d/98-websrv-02_sshd.conf

	/var/log/websrv-02/rsyslog_sshd.log {
	    daily
	    rotate 30
	    compress
	    lastaction
	        DATE=$(date +"%Y-%m-%d")
	        echo "$(date)" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
	        for i in $(seq 1 30); do
	            FILE="/var/log/websrv-02/rsyslog_sshd.log.$i.gz"
	            if [ -f "$FILE" ]; then
	                HASH=$(/usr/bin/sha256sum "$FILE" | awk '{ print $1 }')
	                echo "rsyslog_sshd.log.$i.gz "$HASH"" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
	            fi
	        done
	        systemctl restart rsyslog
	    endscript
	}

3. Executar a configuração:
	sudo logrotate -f /etc/logrotate.d/98-websrv-02_sshd.conf
	
4. Visualizar conteúdo do diretório:
	ls -lsa

5. Verificar conteúdo do arquivo:
	cat hashes_2025-03-09_rsyslog_sshd.txt 

----
Perguntas:
----

1. Com base na configuração do logrotate /etc/logrotate.d/98-websrv-02_sshd.conf, quantas versões de cópias antigas de arquivos de log compactados serão mantidas?

2. Com base na configuração do logrotate, qual é a frequência de rotação do log?


----
Seção 3
Prática: Prabalhando com logs - LogViewer
----
LogViewer é um aplicativo da Web para monitorar logs do servidor em tempo real no navegador.

1. Download da aplicação
	https://github.com/sevdokimov/log-viewer?tab=readme-ov-file

2. Executar 
	log-viewer-1.0.10/logviewer.sh

3. Abrir no navegador
	http://localhost:8111
	Selecionar um log do sistema de arquivos.

----
Seção 4
Prática: análise de logs
----

Criação de arquivo de log analisado e consolidado usando ferramentas Unix como cat, grep, sed, sort, uniq e awk

Antes de perguntar onde há arquivos de log. Busque na internet alguns exemplos e faça download:
	filetype:log access.log
	filetype: log inurl:"access.log" 

1. Processando nginx access.log
	awk -F'[][]' '{print "[" $2 "]", "--- /var/log/nginx/access.log ---", "\"" $0 "\""}' /var/log/nginx/access.log  | sed "s/ +0000//g" > /tmp/parsed_consolidatedn.log

2. Processando rsyslog_cron.log
	awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_cron.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_cron.log >> /tmp/parsed_consolidatedr.log

3. Processando rsyslog_sshd.log
	awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_sshd.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_sshd.log >> /tmp/parsed_consolidateds.log

4. Processando api_json.log
	awk -F'"' '{timestamp = $4; converted = strftime("[%d/%b/%Y:%H:%M:%S]", mktime(substr(timestamp, 1, 4) " " substr(timestamp, 6, 2) " " substr(timestamp, 9, 2) " " substr(timestamp, 12, 2) " " substr(timestamp, 15, 2) " " substr(timestamp, 18, 2) " 0 0")); print converted, "--- /var/log/api_json.log ---", "\""$0"\""}' /var/log/api_json.log >> /tmp/parsed_consolidateda.log

5. Explique se há diferenças entre os resultados (saídas dos comandos)


6. grep: para filtrar entrada especifica:

	grep "189.22.221.61" /tmp/parsed_consolidatedg.log > /tmp/filtered_consolidatedg.log

7. sort: para classificar todas as entradas de log por data e hora:

	sort /tmp/parsed_consolidated.log > /tmp/sort_parsed_consolidated.log

8. uniq: para remover entradas duplicadas:

	uniq /tmp/sort_parsed_consolidated.log > /tmp/uniq_sort_parsed_consolidated.log

9. Accessar arquivo log parsedo and consolidado, por meio da ferramenta Log Viewer, usando a URL:

	http://MACHINE_IP:8111/log?path=%2Ftmp%2Funiq_sort_parsed_consolidated.log



