----
Prática: Log Collection com rsyslog
----

Ver status do rsyslog
	sudo systemctl status rsyslog

Criar arquivo
	sudo vim /etc/rsyslog.d/98-websrv-02-sshd.conf

Adicionar conteúdo
	$FileCreateMode 0644
	:programname, isequal, "sshd" /var/log/websrv-02/rsyslog_sshd.log

status rsyslog
	sudo systemctl status rsyslog
	systemctl restart syslog.socket rsyslog.service

Acessar diretório
	cd /var/log/websrv-02

Conectar remoto
	sudo ssh kali@localhost -p 22

Visualizar conteúdo do arquivo
	cat rsyslog_sshd.log

----
Perguntas
----

1. Após configurar o rsyslog para sshd, qual nome de usuário aparece nos logs do sshd em /var/log/websrv-02/rsyslog_sshd.log?

2. Existe algo indicando tentativas de login com falha ou força bruta?

3. Qual é o endereço IP aparece no conteúdo do arquivo de /var/log/websrv-02/rsyslog_sshd.log?

4. Com base nos logs gerados em /var/log/websrv-02/rsyslog_sshd.log, existe algum comando executado pelo usuário root?



----
Practical Activity: Log Management with logrotate
---
logrotate: ferramenta que automatiza a rotação, compressão e gerenciamento de arquivos de log, garantindo que os arquivos de log sejam manipulados sistematicamente.

cd /var/log/websrv-02

sudo vim /etc/logrotate.d/98-websrv-02_sshd.conf

/var/log/websrv-02/rsyslog_sshd.log {
    daily
    rotate 30
    compress
    lastaction
        DATE=$(date +"%Y-%m-%d")
        echo "$(date)" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
        for i in $(seq 1 30); do
            FILE="/var/log/websrv-02/rsyslog_sshd.log.$i.gz"
            if [ -f "$FILE" ]; then
                HASH=$(/usr/bin/sha256sum "$FILE" | awk '{ print $1 }')
                echo "rsyslog_sshd.log.$i.gz "$HASH"" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
            fi
        done
        systemctl restart rsyslog
    endscript
}

sudo logrotate -f /etc/logrotate.d/98-websrv-02_sshd.conf
ls -lsa
cat hashes_2025-03-09_rsyslog_sshd.txt 

Perguntas:

1. Com base na configuração do logrotate /etc/logrotate.d/98-websrv-02_sshd.conf, quantas versões de cópias antigas de arquivos de log compactados serão mantidas?

2. Com base na configuração do logrotate, qual é a frequência de rotação do log?

---
Prática: trabalhando com logs
---
1. LogViewer é um aplicativo da Web para monitorar logs do servidor em tempo real no navegador.

	https://github.com/sevdokimov/log-viewer?tab=readme-ov-file

2. Criação de arquivo de log analisado e consolidado usando ferramentas Unix como cat, grep, sed, sort, uniq e awk

filetype:log access.log

filetype: log inurl:"access.log" 


# Processando nginx access log
	awk -F'[][]' '{print "[" $2 "]", "--- /var/log/nginx/access.log ---", "\"" $0 "\""}' /var/log/nginx/access.log  | sed "s/ +0000//g" > /tmp/parsed_consolidatedn.log

# Processando rsyslog_cron.log
	awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_cron.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_cron.log >> /tmp/parsed_consolidatedr.log

# Processando rsyslog_sshd.log
	awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_sshd.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_sshd.log >> /tmp/parsed_consolidateds.log

# Processando api_json.log
	awk -F'"' '{timestamp = $4; converted = strftime("[%d/%b/%Y:%H:%M:%S]", mktime(substr(timestamp, 1, 4) " " substr(timestamp, 6, 2) " " substr(timestamp, 9, 2) " " substr(timestamp, 12, 2) " " substr(timestamp, 15, 2) " " substr(timestamp, 18, 2) " 0 0")); print converted, "--- /var/log/api_json.log ---", "\""$0"\""}' /var/log/api_json.log >> /tmp/parsed_consolidateda.log


Outros exemplos

grep: para filtrar entrada especifica:

	grep "189.22.221.61" /tmp/parsed_consolidatedg.log > /tmp/filtered_consolidatedg.log

sort: para classificar todas as entradas de log por data e hora:

	sort /tmp/parsed_consolidated.log > /tmp/sort_parsed_consolidated.log

uniq: para remover entradas duplicadas:

	uniq /tmp/sort_parsed_consolidated.log > /tmp/uniq_sort_parsed_consolidated.log

Accessar arquivo log parsedo and consolidado, por meio da ferramenta Log Viewer, usando a URL:

	http://MACHINE_IP:8111/log?path=%2Ftmp%2Funiq_sort_parsed_consolidated.log



