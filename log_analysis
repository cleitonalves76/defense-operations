-----------------------------
Se√ß√£o 1: Locais comuns de arquivos de log
-----------------------------

Um aspecto crucial da an√°lise de log √© entender onde localizar os arquivos de log gerados por v√°rios aplicativos e sistemas. 
Embora os caminhos dos arquivos de log possam variar devido √†s configura√ß√µes do sistema, vers√µes de software e configura√ß√µes personalizadas, 
conhecer os locais comuns dos arquivos de log √© essencial para uma investiga√ß√£o eficiente e detec√ß√£o de amea√ßas.

De forma geral:
	/var/log

    Web Servers:
        Nginx:
            Access Logs: /var/log/nginx/access.log
            Error Logs: /var/log/nginx/error.log
        Apache:
            Access Logs: /var/log/apache2/access.log
            Error Logs: /var/log/apache2/error.log

    Databases:
        MySQL:
            Error Logs: /var/log/mysql/error.log
        PostgreSQL:
            Error and Activity Logs: /var/log/postgresql/postgresql-{version}-main.log

    Web Applications:
        PHP:
            Error Logs: /var/log/php/error.log

    Operating Systems:
        Linux:
            General System Logs: /var/log/syslog
            Authentication Logs: /var/log/auth.log

    Firewalls and IDS/IPS:
        iptables:
            Firewall Logs: /var/log/iptables.log
        Snort:
            Snort Logs: /var/log/snort/

-----------------------------
Tarefa 1: Em sua VM Linux
-----------------------------

1. Verifique o conte√∫do dos arquivos mencionados anteriormente (* dos existentes)

2. Existe um padr√£o dos dados armazenados nos logs?

-----------------------------
Se√ß√£o 2: Log centralizado
-----------------------------

O rsyslog √© o servi√ßo padr√£o de registro e encaminhamento de logs em muitos sistemas Linux. 
Ele coleta mensagens geradas pelo sistema operacional e por aplica√ß√µes, processa essas mensagens e pode armazen√°-las localmente ou envi√°-las para servidores remotos.

- coleta de eventos
- filtragem e roteamento
- armazenamento
- encaminhamento centralizado

Para que ele serve:

- No Linux, o rsyslog √© usado para:
- Registrar eventos do sistema (/var/log/*)
- Centralizar logs de m√∫ltiplas m√°quinas
- Enviar logs para SIEMs
- Aplicar filtros e regras
- Converter formatos de log

Em ambientes corporativos, ele √© pe√ßa-chave da arquitetura de logging centralizado.

-----------------------------
Pr√°tica: Log Collection com rsyslog
-----------------------------

1. Ver status do rsyslog
	sudo systemctl status rsyslog

	Se necess√°rio:
	sudo apt install rsyslog        # Instalar rsyslog
	sudo systemctl start rsyslog    # Start o service
	sudo tail -f /var/log/syslog   # Visualizar logs em real-time

2. Criar arquivos e diret√≥rio
	cd /va/log
	sudo mkdir /websrv-02
	sudo touch rsyslog_sshd.log
	
	sudo vim /etc/rsyslog.d/98-websrv-02-sshd.conf
	
3. Adicionar conte√∫do
	$FileCreateMode 0644
	:programname, isequal, "sshd" /var/log/websrv-02/rsyslog_sshd.log

4. Status rsyslog
	sudo systemctl status rsyslog
	sudo systemctl restart syslog.socket rsyslog.service

5. Acessar diret√≥rio
	cd /var/log/websrv-02

6. Conectar remoto
	sudo ssh kali@localhost -p 22

7. Visualizar conte√∫do do arquivo
	cat rsyslog_sshd.log

----
Perguntas
----

1. Ap√≥s configurar o rsyslog para sshd, qual nome de usu√°rio aparece nos logs do sshd em /var/log/websrv-02/rsyslog_sshd.log?
2. Existe algo indicando tentativas de login com falha ou for√ßa bruta?
3. Qual √© o endere√ßo IP aparece no conte√∫do do arquivo de /var/log/websrv-02/rsyslog_sshd.log?
4. Com base nos logs gerados em /var/log/websrv-02/rsyslog_sshd.log, existe algum comando executado pelo usu√°rio root?

-----------------------------
Laborat√≥rio Pr√°tico ‚Äî Centraliza√ß√£o de Logs com rsyslog
-----------------------------

Objetivos:
- configurar servidor de logs
- enviar logs de um cliente Linux
- validar recebimento
-detectar eventos de seguran√ßa

Topologia do laborat√≥rio
	[ CLIENTE LINUX ] --> [ SERVIDOR DE LOG ]
    	 rsyslog                 rsyslog
  		 (sender)                (receiver)

Pode ser feito com:
	duas VMs
	VM + container
	duas m√°quinas f√≠sicas

Pr√©-requisitos:
Em ambas as m√°quinas:
	sudo apt update
	sudo apt install rsyslog -y

Verificar servi√ßo:
	systemctl status rsyslog

Parte 1: Configurar o Servidor de Logs
1. Editar configura√ß√£o
No servidor:
	sudo vim /etc/rsyslog.conf

Descomente ou adicione:
# Receber via UDP
module(load="imudp")
input(type="imudp" port="514")

# Receber via TCP (recomendado)
module(load="imtcp")
input(type="imtcp" port="514")

2. Criar diret√≥rio para logs remotos
	sudo mkdir -p /var/log/remote
	sudo chmod 755 /var/log/remote

3. Criar template por host
	Adicione no final do arquivo:

		$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"
		*.* ?RemoteLogs

Isso separa logs por m√°quina.

4. Reiniciar rsyslog
sudo systemctl restart rsyslog

5. Liberar firewall (se houver)
	Ubuntu:
		sudo ufw allow 514/tcp
		sudo ufw allow 514/udp


Parte 2 ‚Äî Configurar o Cliente (Sender)

1. Editar configura√ß√£o
No cliente:
	sudo vim /etc/rsyslog.conf
	
Adicionar no final:

*.* @@IP_DO_SERVIDOR:514

Aten√ß√£o:
	@ = UDP
	@@ = TCP (RECOMENDADO)

2. Reiniciar rsyslog
	sudo systemctl restart rsyslog

Parte 3 ‚Äî Testar envio de logs

1. Gerar log manual no cliente
	logger "LAB RSYSLOG TESTE"

2.Verificar no servidor
	ls /var/log/remote/

Depois:

cat /var/log/remote/*/*.log

Voc√™ deve ver:
	LAB RSYSLOG TESTE

Parte 4 ‚Äî Simula√ß√£o de evento de seguran√ßa

No cliente, gere falhas de SSH:
	ssh usuario_inexistente@localhost

Depois verifique no servidor:
	grep "Failed password" -R /var/log/remote

Agora voc√™ tem detec√ß√£o centralizada.

Parte 5 ‚Äî Monitoramento em tempo real (modo SOC)

No servidor:
	tail -f /var/log/remote/*/*.log

Checklist de valida√ß√£o

Voc√™ concluiu se:
	- servidor recebe logs
	- cliente envia via TCP
	- logs separados por host
	- evento de seguran√ßa vis√≠vel
	- monitoramento em tempo real funciona

Quer o pr√≥ximo n√≠vel?

Posso montar:

üîê rsyslog com TLS (produ√ß√£o)

üìä integra√ß√£o com Elasticsearch/Kibana

üïµÔ∏è detec√ß√£o autom√°tica de brute force

üß™ laborat√≥rio com docker-compose

Qual n√≠vel voc√™ quer agora?

exemplo para evento de servidor apache com rsyslog

Perfeito ‚Äî vamos montar um exemplo pr√°tico e realista de evento do Apache sendo processado pelo rsyslog, no n√≠vel que um SOC realmente usa.

A ideia √©:

‚úÖ Apache gera log
‚úÖ rsyslog coleta
‚úÖ rsyslog envia para servidor central
‚úÖ voc√™ detecta evento

üß™ Cen√°rio do laborat√≥rio
Apache ‚Üí access.log ‚Üí rsyslog ‚Üí servidor de logs
üìã Pr√©-requisitos

No cliente web:

sudo apt install apache2 rsyslog -y

Verificar Apache:

systemctl status apache2
üîç PASSO 1 ‚Äî Confirmar logs do Apache

Os logs padr√£o ficam em:

/var/log/apache2/access.log
/var/log/apache2/error.log

Gerar tr√°fego de teste:

curl http://localhost

Verificar:

tail -f /var/log/apache2/access.log

‚úÖ Voc√™ deve ver requisi√ß√µes HTTP.

‚öôÔ∏è PASSO 2 ‚Äî Fazer rsyslog ler o log do Apache

Por padr√£o o rsyslog n√£o l√™ arquivos arbitr√°rios, ent√£o precisamos do m√≥dulo imfile.

1Ô∏è‚É£ Criar arquivo de configura√ß√£o
sudo nano /etc/rsyslog.d/apache.conf

Adicionar:

module(load="imfile")

input(type="imfile"
      File="/var/log/apache2/access.log"
      Tag="apache-access"
      Severity="info"
      Facility="local6")

input(type="imfile"
      File="/var/log/apache2/error.log"
      Tag="apache-error"
      Severity="error"
      Facility="local6")

‚úÖ Agora o rsyslog passa a ingerir logs do Apache.

üîÑ PASSO 3 ‚Äî Reiniciar rsyslog
sudo systemctl restart rsyslog
üß™ PASSO 4 ‚Äî Validar ingest√£o local

Gerar requisi√ß√£o:

curl http://localhost/testersyslog

Ver no syslog:

grep apache-access /var/log/syslog

‚úÖ Se apareceu ‚Üí ingest√£o OK.

üöÄ PASSO 5 ‚Äî Enviar para servidor remoto

No cliente, adicione em /etc/rsyslog.conf:

local6.* @@IP_DO_SERVIDOR:514

üî¥ Boa pr√°tica: enviar s√≥ facility do Apache.

Reiniciar:

sudo systemctl restart rsyslog
üîç PASSO 6 ‚Äî Validar no servidor de logs

No servidor:

grep apache-access -R /var/log/remote

ou tempo real:

tail -f /var/log/remote/*/*
üö® PASSO 7 ‚Äî Simula√ß√µes de seguran√ßa (muito √∫til em aula)
üî¥ 1. Scan de diret√≥rio suspeito

No cliente:

curl http://localhost/admin
curl http://localhost/phpmyadmin
curl http://localhost/.env

Detectar no servidor:

grep -E "admin|phpmyadmin|.env" -R /var/log/remote
üî¥ 2. User-Agent suspeito
curl -A "sqlmap" http://localhost

Detectar:

grep -i sqlmap -R /var/log/remote

üî• Excelente exerc√≠cio de SOC.







xxxx

----
Se√ß√£o 3
Pratica: Log Management com logrotate
----

logrotate: ferramenta que automatiza a rota√ß√£o, compress√£o e gerenciamento de arquivos de log, garantindo que os arquivos de log sejam manipulados sistematicamente.

1. Acessa o diret√≥rio:
	cd /var/log/websrv-02

2. Criar arquivo conf:
	sudo vim /etc/logrotate.d/98-websrv-02_sshd.conf

	/var/log/websrv-02/rsyslog_sshd.log {
	    daily
	    rotate 30
	    compress
	    lastaction
	        DATE=$(date +"%Y-%m-%d")
	        echo "$(date)" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
	        for i in $(seq 1 30); do
	            FILE="/var/log/websrv-02/rsyslog_sshd.log.$i.gz"
	            if [ -f "$FILE" ]; then
	                HASH=$(/usr/bin/sha256sum "$FILE" | awk '{ print $1 }')
	                echo "rsyslog_sshd.log.$i.gz "$HASH"" >> "/var/log/websrv-02/hashes_"$DATE"_rsyslog_sshd.txt"
	            fi
	        done
	        systemctl restart rsyslog
	    endscript
	}

3. Executar a configura√ß√£o:
	sudo logrotate -f /etc/logrotate.d/98-websrv-02_sshd.conf
	
4. Visualizar conte√∫do do diret√≥rio:
	ls -lsa

5. Verificar conte√∫do do arquivo:
	cat hashes_2025-03-09_rsyslog_sshd.txt 

----
Perguntas:
----

1. Com base na configura√ß√£o do logrotate /etc/logrotate.d/98-websrv-02_sshd.conf, quantas vers√µes de c√≥pias antigas de arquivos de log compactados ser√£o mantidas?

2. Com base na configura√ß√£o do logrotate, qual √© a frequ√™ncia de rota√ß√£o do log?


----
Se√ß√£o 4
Pr√°tica: Trabalhando com logs - LogViewer e ULogViewer
----

LogViewer √© um aplicativo Web para monitorar logs do servidor em tempo real no navegador.

1. Download da aplica√ß√£o
	https://github.com/sevdokimov/log-viewer?tab=readme-ov-file

2. Executar 
	log-viewer-1.0.10/logviewer.sh

3. Abrir no navegador
	http://localhost:8111
	Selecionar um log do sistema de arquivos.

ULogViewer √© um aplicativo Web que d√° suporte para ler, parsear e analisar v√°rios tipos de arquivos de log.
	Fazer download e executar ULogViewer
	https://github.com/carina-studio/ULogViewer

Tarefa: Abrir e analisar arquivos (reposit√≥rio do Teams)
	Apache-Access.log
	Apache-Error.log
	linux.log

----
Se√ß√£o 5
Pratica: Log Analysis Tools: Command Line
---

Utilize o arquivo: apache-ex.log

1. cat
2. less
3. tail
4. wc
5. cut
6. sort
7. uniq
8. sed
Para substituir todas as ocorr√™ncias de "31/Jul/2023" por "July 31, 2023"
	sed 's/31\/Jul\/2023/July 31, 2023/g' apache-ex.log

9. awk
Para imprimir entradas de log onde o c√≥digo de resposta HTTP √© maior ou igual a 400 (o que indicaria status de erro HTTP), podemos usar o seguinte comando:
	awk '$9 >= 400' apache-ex.log

10. grep
Entrada de log que atinja a p√°gina /admin.php no servidor, podemos procurar por "admin" para retornar quaisquer resultados relevantes:
	grep "admin" apache-ex.log

N√∫mero de ocorrencias
	grep -c "admin" apache-ex.log

N√∫mero da linha
	grep -n "admin" apache-ex.log

N√£o cont√©m um padr√£o (-v invert)
	grep -v "/index.php" apache-ex.log | grep "203.64.78.90"

Tarefa: 
	Analise o arquivo access.log e descubra se houve tentativa de bruteforce

----
Se√ß√£o 6
Pr√°tica: an√°lise de logs
----

Cria√ß√£o de arquivo de log analisado e consolidado usando ferramentas Unix como cat, grep, sed, sort, uniq e awk

Para obter arquivos, utilize o reposit√≥rio do Teams ou busque na internet alguns exemplos e fa√ßa download:
	filetype:log access.log
	filetype: log inurl:"access.log" 

Tarefa:
	Execute cada um dos exemplos a seguir e explique sua sa√≠da:

1. Processando nginx access.log
	awk -F'[][]' '{print "[" $2 "]", "--- /var/log/nginx/access.log ---", "\"" $0 "\""}' /var/log/nginx/access.log  | sed "s/ +0000//g" > /tmp/parsed_consolidatedn.log

2. Processando rsyslog_cron.log
	awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_cron.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_cron.log >> /tmp/parsed_consolidatedr.log

3. Processando rsyslog_sshd.log
	awk '{ original_line = $0; gsub(/ /, "/", $1); printf "[%s/%s/2023:%s] --- /var/log/websrv-02/rsyslog_sshd.log --- \"%s\"\n", $2, $1, $3, original_line }' /var/log/websrv-02/rsyslog_sshd.log >> /tmp/parsed_consolidateds.log

4. Processando api_json.log
	awk -F'"' '{timestamp = $4; converted = strftime("[%d/%b/%Y:%H:%M:%S]", mktime(substr(timestamp, 1, 4) " " substr(timestamp, 6, 2) " " substr(timestamp, 9, 2) " " substr(timestamp, 12, 2) " " substr(timestamp, 15, 2) " " substr(timestamp, 18, 2) " 0 0")); print converted, "--- /var/log/api_json.log ---", "\""$0"\""}' /var/log/api_json.log >> /tmp/parsed_consolidateda.log

5. Explique se h√° diferen√ßas entre os resultados (sa√≠das dos comandos)

6. grep: para filtrar entrada especifica:

	grep "189.22.221.61" /tmp/parsed_consolidatedg.log > /tmp/filtered_consolidatedg.log

7. sort: para classificar todas as entradas de log por data e hora:

	sort /tmp/parsed_consolidated.log > /tmp/sort_parsed_consolidated.log

8. uniq: para remover entradas duplicadas:

	uniq /tmp/sort_parsed_consolidated.log > /tmp/uniq_sort_parsed_consolidated.log

9. Accessar arquivo log parsedo and consolidado, por meio da ferramenta Log Viewer, usando a URL:

	http://MACHINE_IP:8111/log?path=%2Ftmp%2Funiq_sort_parsed_consolidated.log


----
Se√ß√£o 7: Log Analysis Tools: Regular Expressions
----

Regular Expressions usando grep
	Utilize o arquivo: apache-ex2.log

O  arquivo de log apache-ex2.log, cont√©m entradas de log de um site de blog. O site √© estruturado para que cada postagem de blog tenha seu ID exclusivo, obtido do banco de dados dinamicamente por meio do par√¢metro de URL da postagem. 

1. Se estivermos interessados ‚Äã‚Äãapenas nas postagens de blog espec√≠ficas com um ID entre 10-19, podemos executar o seguinte padr√£o de express√£o regular grep no arquivo de log:

	grep -E 'post=1[0-9]' apache-ex2.log

Op√ß√£o -E para indicar que estamos pesquisando um padr√£o e n√£o apenas uma string.

Tarefa: 
	Usando o arquivo apache-ex2.log, crie 3 regex com grep

----
Se√ß√£o 8: Regular Expressions para Log Parsing
---

Express√µes regulares tamb√©m desempenham um papel crucial na an√°lise de log, que √© o processo de dividir entradas de log em componentes estruturados e extrair informa√ß√µes relevantes deles. 

Considere a seguinte entrada de log bruto e n√£o estruturado:

----------------------------------------           
126.47.40.189 - - [28/Jul/2023:15:30:45 +0000] "GET /admin.php HTTP/1.1" 200 1275 "" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.9999.999 Safari/537.36"
----------------------------------------

Do ponto de vista da seguran√ßa, v√°rios campos seriam ben√©ficos para extrair e utilizar em um SIEM. Alguns deles incluem:

- IP address
	- Source IP
	- Destination IP
- timestamp
- HTTP method (POST, GET, or PUT, for example)
- URL
- user-agent
- Hostname
- Source port
- Destination port
- Action taken by the firewall
- Source country
- Destination country
- Application discovered

RegExr (https://regexr.com/) √© uma ferramenta online para ajudar a ensinar, construir e testar padr√µes de express√µes regulares.

Como exemplo b√°sico, se quisermos extrair apenas o endere√ßo IP remoto deste log, podemos pensar na estrutura do endere√ßo IP logicamente.

----------------------------------------           
126.47.40.189 - - [28/Jul/2023:15:30:45 +0000] "GET /admin.php HTTP/1.1" 200 1275 "" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.9999.999 Safari/537.36"
----------------------------------------

\b([0-9]{1,3}\.){3}[0-9]{1,3}\b

Quebrando esse padr√£o, ele come√ßa e termina com uma √¢ncora de limite de palavra \b para garantir que correspondamos a endere√ßos IP completos. Entre eles, definimos o seguinte:
	[0-9]{1,3} - Corresponde a um a tr√™s d√≠gitos para corresponder a n√∫meros de 0 a 999.
	\. - Escape corresponde a um caractere literal . no endere√ßo IP.
	{3} - Especifica que o grupo de captura anterior ([0-9]{1,3}\.) deve ser repetido tr√™s vezes.
	[0-9]{1,3} - Novamente, isso corresponde a n√∫meros de 0 a 999, completando o quarto octeto do endere√ßo IP.

Tarefa: 
1. Usando uma linha do arquivo log, crie 3 regex para Log Parsing
2. Visite o site da Broadcom (https://techdocs.broadcom.com/us/en/symantec-security-software/information-security/symantec-cloudsoc/cloud/audit-home/barracuda-home/log-formats/syslog-log-sample.html), obtenha alguns logs e normalize


Mais:
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_expressions/Cheatsheet
https://support.kaspersky.com/cyber-trace/4.4/171633




----
Se√ß√£o 8: Regex com CyberChef
----

https://cyberchef.org

----------------------------------------           
126.47.40.189 - - [28/Jul/2023:15:30:45 +0000] "GET /admin.php HTTP/1.1" 200 1275 "" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.9999.999 Safari/537.36"
----------------------------------------

No cyberchef, escolha uma das op√ß√µes de regex existentes e analise a sa√≠da

----
Se√ß√£o 9: Anatomia do Log de Eventos do Windows
----

Os logs de eventos do Windows fornecem informa√ß√µes detalhadas sobre o sistema, a seguran√ßa e os aplicativos instalados em um sistema operacional Windows. 

Default formato/extens√£o:
	.evt
	.evtx
Podem ser extra√≠dos nos formatos:
	.xml
	.csv
	.txt
Localidade dos arquivos:
	C:\WINDOWS\System32\winevt\Logs

Ferramenta de visualiza√ß√£o: Event Viewer 
	Execute: eventvwr.msc

Categorias
Windows Logs
	Application
	Security
	Setup
	System
	Fowarded Events
Applications and Services Logs
	Hardware Events
	Microsoft
	OpenSSH
	Windows PowerShell

Os dados PID e TID s√£o ben√©ficos para rastreamento de processos, correla√ß√£o e compreens√£o do fluxo natural de eventos durante a an√°lise de logs.

Aprender a anatomia dos arquivos de log do Windows √© essencial, mas voc√™ tamb√©m precisar√° saber os IDs e detalhes indicativos do log de eventos. Portanto, voc√™ poder√° rastrear e entender os detalhes de uma anomalia potencial ou uma tentativa de intrus√£o. Alguns IDs √∫teis do log de eventos do Windows est√£o listados abaixo:

Account Management	
	4720: User account creation.
	4722: User account enabled.
	4723: Attempt to change an account password.
	The user attempts to change their password.
	4724: Attempt to reset the account password.
The user attempts to reset the password of another account.
	4725: Account disable.
	4726: Account removal.
	Account Logon	
	4624: Successful logon.
	4625: Failed logon.
	4634 and 4647: Logoff.
	4779: Session disconnect.
Scheduled Tasks	
	4698: Scheduled task creation.
	4702: Scheduled task updated.
	4699: Scheduled task deletion.
Security	
	1100: Logging service disabled.
	1102: Log deletion.
	1116: Malware detection.

Mais informa√ß√µes sobre IDs:
https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/default.aspx
https://learn.microsoft.com/pt-br/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor

----
Se√ß√£o 10: logs de eventos CLI
----
Ferramentas para consultar logs de eventos por meio da linha de comando e/ou PowerShell.

1. wevtutil.exe: permite recuperar informa√ß√µes sobre logs de eventos e publicadores. (tamb√©m pode usado para instalar e desinstalar manifestos de eventos, executar consultas e exportar, arquivar e limpar logs).

No PowerShell, execute:

Help do comando wevtutil.exe
	wevtutil.exe /?

Exibe os tr√™s eventos mais recentes do log do aplicativo em formato textual:
	wevtutil qe Application /c:3 /rd:true /f:text

Mais exemplos:
	https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil

2. Get-WinEvent: obt√©m eventos de logs de eventos e arquivos de log de rastreamento de eventos em computadores locais e remotos.

No PowerShell, execute:

Obter todos os logs de um computador
	Get-WinEvent -ListLog *

Obter provedores de log de eventos e nomes de log
	Get-WinEvent -ListProvider *

Filtragem de log
	Get-WinEvent -LogName Application | Where-Object { $_.ProviderName -Match 'WLMS' }

Obter logs de eventos de um servidor
	Get-WinEvent -ListLog * -ComputerName localhost | Where-Object { $_.RecordCount }

Mais exemplos:
	https://learn.microsoft.com/pt-br/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.4

----
Se√ß√£o 11: Sysmon
----
	Monitorar e registrar endpoints e ambientes - Ambientes Windows
	Download do SysInternalse da configura√ß√£o do Sysmon SwiftOnSecurity sysmon-config (https://github.com/SwiftOnSecurity/sysmon-config)

Iniciando o Sysmon
	Sysmon.exe -accepteula -i sysmonconfig-export.xml
	O log de eventos do Sysmon est√° localizado em: Event Viewer | Applications and Services Logs/Microsoft/Windows/Sysmon/Operational
----
Uso do Sysmon
----

Como a maioria das atividades normais ou "ru√≠dos" vistos em uma rede s√£o exclu√≠dos ou filtrados com o Sysmon, podemos nos concentrar em eventos significativos. Isso nos permite identificar e investigar rapidamente atividades suspeitas. Ao monitorar ativamente uma rede, voc√™ poder√° usar v√°rias detec√ß√µes e t√©cnicas simultaneamente em um esfor√ßo para identificar amea√ßas.

Vamos entender Sysmon Event ID: https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90001

Use Get-WinEvent (PowerShell) ou wevutil.exe (cmd) para acessar e filtrar logs de forma manual. No entanto, o mais adequado √© incorporar o Sysmon ao SIEM ou outras solu√ß√µes de detec√ß√£o. 


Baixar arquivos do resposit√≥rio do Teams

Exemplo de uso de Get-WinEvent para procurar conex√µes de rede vindas da porta 4444.

	Get-WinEvent -Path Filtering.evtx -FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=4444'

Perguntas:
	Quantos eventos ID 3 est√£o em Filtering.evtx?
		(Get-WinEvent -Path Filtering.evtx -FilterXPath '*/System/EventID=3').count

	Qual √© o hor√°rio UTC do primeiro evento de rede no mesmo arquivo de log?
		Get-WinEvent -Path Filtering.evtx -FilterXPath '*/System/EventID=3' -Oldest -MaxEvents 1 | Select-Object -Property *

No Visualizador de Eventos, abra o arquivo Hunting_Metasploit.evtx, e tente visualizaruma um upload do Metasploit sendo descarregada na m√°quina.
	exemplo: DestinationPort: 444

Portas abertas com o PowerShell
	Get-WinEvent -Path .\Hunting_Metasploit.evtx -FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=4444'

Detectando Mimikatz

Mimikatz √© bem conhecido e comumente usado para "despejar" credenciais da mem√≥ria em Windows

Podemos usar o ID do evento ProcessAccess para identificar comportamento anormal de Local Security Authority Subsystem Service (LSASS). Este evento, junto com o LSASS, mostraria um potencial abuso do LSASS que geralmente conecta de volta ao Mimikatz ou algum outro tipo de ferramenta de dumping de credenciais.
Mais informa√ß√µes em: https://www.microsoft.com/en-us/security/blog/2022/10/05/detecting-and-preventing-lsass-credential-dumping-attacks/?msockid=07a20ce48b07644f23131c558ad26504

Para detectar comportamento anormal do LSASS com o PowerShell:
	Get-WinEvent -Path Practice\Hunting_Mimikatz.evtx -FilterXPath '*/System/EventID=10 and */EventData/Data[@Name="TargetImage"] and */EventData/Data="C:\Windows\system32\lsass.exe"'

Plus: Al√©m das t√©cnicas na mem√≥ria, a mem√≥ria do processo LSASS pode ser despejada do host de destino e analisada em um sistema local:
	procdump -ma lsass.exe lsass_dump
	rundll32.exe C:\Windows\System32\comsvcs.dll MiniDump PID lsass.dmp

Hunting Malware
O malware tem muitas formas e varia√ß√µes com diferentes objetivos finais. Os dois tipos de malware nos quais nos concentraremos s√£o Remote Access Trojans (RATs) e backdoors. 

No Visualizador de Eventos, abra o arquivo Hunting_Rats.evtx e tente visualizar o evento.
	exemplo: rat.exe
Para detectar comportamento via PS 
	Get-WinEvent -Path .\Hunting_Rats.evtx -FilterXPath '*/System/EventID=3 and */EventData/Data[@Name="DestinationPort"] and */EventData/Data=8080'


----
Tarefa
----

Os arquivos de eventos usados ‚Äã‚Äãnesta tarefa devem ser obtidos dos reposit√≥rios EVTX-ATTACK-SAMPLES (https://github.com/sbousseaden/EVTX-ATTACK-SAMPLES/tree/master) e SysmonResources (https://github.com/jymcheong/SysmonResources) do Github. E tamb√©m est√£o dispon√≠veis no reposit√≥rio do Teams.

Alguns logs suspeitos foram obtidos e atribuiram a voc√™ executar a investiga√ß√£o.

Investiga√ß√£o 1 - E esse USB!
	H√° informa√ß√£o de que um arquivo malicioso foi inserido em um host por um USB malicioso.
	Arquivo de log: Investigation-1.evtx
	- Qual √© a chave de registro completa do dispositivo USB chamando svchost.exe na Investiga√ß√£o 1?
	- Qual √© o nome do dispositivo quando √© chamado por RawAccessRead na Investiga√ß√£o 1? (EventID para RawAccessRead √© 9)
	- Qual √© o primeiro exe que o processo executa na Investiga√ß√£o 1?

Investiga√ß√£o 2 - Este n√£o √© um arquivo HTML?
	Outro arquivo suspeito apareceu em seus logs e conseguiu executar um c√≥digo se mascarando como um arquivo HTML, evitando suas detec√ß√µes antiv√≠rus.
	Arquivo de logs: Investigation-2.evtx
		Dica: A tag CommandLine pode dizer o payload que foi executado para disparar o evento.
	- Qual √© o caminho completo do payload na Investiga√ß√£o 2?
	- Qual √© o caminho completo do arquivo que o payload mascarou na Investiga√ß√£o 2?
	- Qual bin√°rio assinado executou o payload na Investiga√ß√£o 2?
		Mshta.exe: https://attack.mitre.org/techniques/T1218/005/
	- Qual √© o IP do advers√°rio na Investiga√ß√£o 2?
	- Qual porta de conex√£o de retorno √© usada na Investiga√ß√£o 2?

Investiga√ß√£o 3.1 - 3.2 - Onde est√° o seguran√ßa quando voc√™ precisa

	Sua equipe informou que o advers√°rio conseguiu configurar a persist√™ncia em seus endpoints enquanto eles continuam a se mover pela sua rede. Descubra como o advers√°rio conseguiu obter persist√™ncia usando os logs fornecidos.
	Arquivo de logs Investigation-3.1.evtx e Investigation-3.2.evtx
	- Qual √© o IP do advers√°rio suspeito na Investiga√ß√£o 3.1?
	- Qual √© o nome do host do endpoint afetado na Investiga√ß√£o 3.1?
	- Qual √© o nome do host do servidor C2 que se conecta ao endpoint na Investiga√ß√£o 3.1?
	- Onde no registro do payload foi armazenada na Investiga√ß√£o 3.1?
		Sabe o que fazer com esse c√≥digo? 
		N√£o... ent√£o que tal um decode
	- Qual c√≥digo de inicializa√ß√£o do PowerShell foi usado para iniciar o payload na Investiga√ß√£o 3.1?
	- Qual √© o IP do advers√°rio na Investiga√ß√£o 3.2?
	- Qual √© o caminho completo local do payload na Investiga√ß√£o 3.2?
	- Qual foi o comando completo usado para criar a tarefa agendada na Investiga√ß√£o 3.2?
	- Qual processo foi acessado por schtasks.exe que seria considerado comportamento suspeito na Investiga√ß√£o 3.2?

Investiga√ß√£o 4 - Construiram uma botnet!
	Como o advers√°rio ganhou uma posi√ß√£o s√≥lida em sua rede, foi trazido √† sua aten√ß√£o que ele pode ter sido capaz de configurar comunica√ß√µes C2 em alguns dos endpoints.
	Arquivo de logs Investigation-4.evtx.
	- Qual √© o IP do advers√°rio na Investiga√ß√£o 4?
	- Em qual porta o advers√°rio est√° operando na Investiga√ß√£o 4?
	- Qual C2 o advers√°rio est√° utilizando na Investiga√ß√£o 4?
